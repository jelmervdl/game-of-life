<!DOCTYPE html>
<html>
	<head>
		<title>GoL</title>
		<style>
			html, body {
				margin: 0;
				padding: 0;
				height: 100%;
			}
		</style>
	</head>
	<body>
		<canvas id="gol"></canvas>
		<script>
			"use strict";

			function GameState(width, height)
			{
				this.width = width;
				this.height = height;
				// this.buffer = new ArrayBuffer(Math.ceil((this.width * this.height) / 8));
				// this.view = new Int8Array(this.buffer);
				this.buffer = new Array(width * height);
			}

			GameState.prototype.isAlive = function(x, y)
			{
				var offset = y * this.width + x;

				// return this.view[offset / 8 | 0] & (1 << offset % 8);
				return this.buffer[offset] == true;
			}

			GameState.prototype.setAlive = function(x, y, alive)
			{
				var offset = y * this.width + x;

				// if (alive)
				// 	this.view[offset / 8 | 0] &= (1 << offset % 8);
				// else
				// 	this.view[offset / 8 | 0] ^= (1 << offset % 8);
				this.buffer[offset] = alive;
			}

			GameState.prototype.next = function()
			{
				var w = this.width,
					h = this.height,
					diff = [];

				for (var i = 0; i < w; ++i)
				{
					for (var j = 0; j < h; ++j)
					{
						var n = 0;
						if (i>0 && j>0 && this.isAlive(i-1, j-1)) n++;
						if (       j>0 && this.isAlive(i  , j-1)) n++;
						if (i<w && j>0 && this.isAlive(i+1, j-1)) n++;
						if (i>0        && this.isAlive(i-1, j  )) n++;
						if (i<w        && this.isAlive(i+1, j  )) n++;
						if (i>0 && j<h && this.isAlive(i-1, j+1)) n++;
						if (       j<h && this.isAlive(i  , j+1)) n++;
						if (i<w && j<h && this.isAlive(i+1, j+1)) n++;

						var alive = (this.isAlive(i, j) && n == 2) || n == 3;

						if (this.isAlive(i, j) !== alive)
							diff.push({'x': i, 'y': j, 'alive': alive});
					}
				}

				return diff;
			}

			GameState.prototype.apply = function(diff)
			{
				for (var i = 0; i < diff.length; ++i)
					this.setAlive(diff[i].x, diff[i].y, diff[i].alive);
			}

			GameState.prototype.randomize = function()
			{
				for (var i = 0; i < this.width; ++i)
					for (var j = 0; j < this.height; ++j)
						this.setAlive(i, j, Math.random() > 0.8);
			}

			function render(g, state, cw, ch)
			{
				g.fillStyle = 'white';
				g.fillRect(0, 0, cw * state.width, ch * state.height);

				g.fillStyle = '#ccc';

				for (var i = 0; i < state.width; ++i)
					for (var j = 0; j < state.height; ++j)
						if (state.isAlive(i, j))
							g.fillRect(i * cw, j * ch, cw, ch);
			}

			function renderDiff(g, diff, cw, ch)
			{
				for (var i = 0; i < diff.length; ++i)
				{
					var cell = diff[i];
					g.fillStyle = cell.alive ? '#ccc' : 'white';
					g.fillRect(cell.x * cw, cell.y * ch, cw, ch);
				}			
			}

			function init()
			{
				var canvas = document.getElementById('gol'),
					g = canvas.getContext('2d'),
					state,
					sx = 2, sy = 2;

				canvas.width = document.body.clientWidth;
				canvas.height = document.body.clientHeight;

				var renderState = function() {
					var diff = state.next();
					renderDiff(g, diff, sx, sy);
					state.apply(diff);
					webkitRequestAnimationFrame(renderState);
				}

				state = new GameState(canvas.width / sx | 0, canvas.height / sy | 0);
				state.randomize();

				window.state = state;

				render(g, state, sx, sy);

				webkitRequestAnimationFrame(renderState);
			}

			init();

			</script>
		</script>
	</body>
</html>